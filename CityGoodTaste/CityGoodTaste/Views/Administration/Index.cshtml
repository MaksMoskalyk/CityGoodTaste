@model CityGoodTaste.Models.Administration

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/Content/css/Custom/Administration.css" type="text/css">


@{
    CityGoodTaste.Models.RestaurantSchema schemaModel = Model.Restaurants.FirstOrDefault().RestaurantSchemas.FirstOrDefault();
} 


<div class="container-fluid minPadding" style="margin-left: auto; margin-right: auto">
    <div class="row">
        <div class="col-sm-2 text-center" style="border-top:none; padding:0;">

                <div>
                    <div id="confirmReservModalBody" style="padding:0px 25px;">
                        <div class="panel panel-default ">
                            <div class="panel-heading">
                                
                                <div class="form-group">
                                    <p style="font-weight:bold">ЗАРЕЗЕРВИРОВАТЬ</p>
                                    <input id="checkboxNewReservs" type="checkbox" name="checkbox" />Бронировать новые<br />
                                </div>
                            </div>                        
                            <div class="panel-body text-center center-block">
                                <p style="font-weight:bold">ВРЕМЯ</p>
                                <div id="timeContainer" class="input-group clockpicker ">
                                    @{
                                        var dtt = DateTime.Now.ToShortTimeString();
                                    }
                                    <input id="timePicker" type="text" class="form-control" value=@dtt>
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-time"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="panel-footer text-center center-block">
                                <p style="font-weight:bold">ДАТА</p>
                                <div id="datepickerContainer" class="form-group center-block">
                                    <div class="input-group">
                                        @{
                                            DateTime dt = DateTime.Now.Date;
                                        }
                                        <input type="text" id="datepicker" value=@dt class="form-control">
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body text-center center-block">
                                <p style="font-weight:bold">КОНТАКТНАЯ ИНФОРМАЦИЯ</p>
                                <div class="form-group">
                                    <input id="name" type="text" class="form-control input-md" name="name" placeholder="Имя">
                                </div>
                                <div class="form-group">
                                    <input id="phone" type="text" class="form-control input-md" name="phone" placeholder="Телефон">
                                </div>
                            </div>
                            <div class="panel-footer text-center center-block">
                                <div>
                                    <button id="reservBt" type="button" class="btn x btn-block btn-success">Зарезервировать</button>
                                </div>
                            </div>
                        </div>
                        
                       
                        </div>

                </div>
        </div>
        <div id="schemaAndInfo">@Html.Partial("_SchemaAndInfoPartial", schemaModel)</div>
        
    </div>
</div>


<a style="visibility: hidden" id="confirmModalLink" data-toggle="modal" data-target="#ConfirmModal" href="#"></a>
<div class="modal fade" id="ConfirmModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        @using (Ajax.BeginForm("ConfirmReservation",
            new { schemaId = Model.Restaurants.FirstOrDefault().RestaurantSchemas.FirstOrDefault().Id,
                restId= Model.Restaurants.FirstOrDefault().Id},
            new AjaxOptions { UpdateTargetId = "schemaAndInfo", OnSuccess="UnCheckNewReservationCheckBox", OnFailure = "reseredTablesFailure", InsertionMode = InsertionMode.Replace }, new { id = "confirmForm" }))
        {
            <div class="modal-content" style="width:400px">
                <div class="modal-header" style="background-color:#333333; color:white">
                    <button id="closeModalReserv" type="button" style="color:white" class="close" data-dismiss="modal">&times;</button>
                    Подтвердить резерв
                </div>
                <div id="confirmReservModalBody" class="modal-body" style="padding:40px 50px;">
                    <p><span style="font-weight:700">Столики:</span></p>
                    <div id="newTablesInfoModal"></div>
                    <div class="form-group">
                        <div style="margin-bottom:10px;"><span style="font-weight:700">Имя:</span><input readonly data-val="true" id="nameModal" type="text" class="form-control input-md" name="name" placeholder="Имя"></div>
                        <div style="margin-bottom:10px;"><span style="font-weight:700">Телефон:</span><input readonly data-val="true" id="phoneModal" type="text" class="form-control input-md" name="phone" placeholder="Телефон"></div>
                        <div style="margin-bottom:10px;"><span style="font-weight:700">Дата:</span><input readonly data-val="true" id="dateModal" type="text" class="form-control" name="date"></div>
                        <div><span style="font-weight:700">Время:</span><input readonly data-val="true" id="timeModal" type="text" class="form-control" name="time"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="sumbitReservBt" type="submit" class="btn btn-success btn-default pull-left">
                        <span class="glyphicon glyphicon-ok"></span>
                        Подтвердить
                    </button>
                    <button class="btn btn-danger btn-default pull-right" data-dismiss="modal">
                        <span class="glyphicon glyphicon-remove"></span>
                        Отмена
                    </button>
                    
                </div>
            </div>
        }
    </div>
</div>


<a style="visibility: hidden" id="unreservModalLink" data-toggle="modal" data-target="#unreservModal" href="#"></a>
<div class="modal fade" id="unreservModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
@using (Ajax.BeginForm("RemoveReservation", new { restId = Model.Restaurants.FirstOrDefault().Id },
    new AjaxOptions { UpdateTargetId = "schemaAndInfo", InsertionMode = InsertionMode.Replace, OnSuccess = "reservSuccess" }))
{
            <div class="modal-content" style="width:400px">
                <div class="modal-header" style="background-color:#333333; color:white">
                    <button id="closeModalUnReserv" type="button" style="color:white" class="close" data-dismiss="modal">&times;</button>
                     Убрать резер
                </div>
                <div id="unReservModalBody" class="modal-body" style="padding:40px 50px;">
                    <p>№ <input readonly data-val="true" id="reservNumber" type="text" class="form-control input-md" name="reservNumber"></p>
                </div>
                <div class="modal-footer">
                    <button id="sumbitUnReservBt" type="submit" class="btn btn-success btn-default pull-left">
                        <span class="glyphicon glyphicon-ok"></span>
                        Подтвердить
                    </button>
                    <button id="closeBtRemoveReservModal" class="btn btn-danger btn-default pull-right" data-dismiss="modal">
                        <span class="glyphicon glyphicon-remove"></span>
                        Отмена
                    </button>

                </div>
            </div>
}   
    </div>
</div>


<a style="visibility: hidden" id="errorModalLink" data-toggle="modal" data-target="#errorModal" href="#"></a>
<div class="modal fade" id="errorModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content" style="width:300px">
            <div class="modal-header" style="background-color:#c34b4b; color:white">
                <span id="failureHeader" style="color:white">Данные не заполнены</span>
                <button id="closeModalError" type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="padding:10px 10px;">
                <p id="failureMsg">Необходимо выбрать столик и заполнить контактную информацию.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success btn-default pull-left" data-dismiss="modal">Ок</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {

        ReservBtClick();

        CheckBoxChecked();

    });


    function reservSuccess() {
        $('#closeModalUnReserv').click();
    }


    function UnCheckNewReservationCheckBox() {
        $('#checkboxNewReservs:checked').prop('checked', false);
        SetDefaultColorAndRemoveAttrNewreservedTD();
    }


    function ReservBtClick() {
        $('#reservBt').click(function () {
            // check info - table / name / phone
            
            if ($('td[newreserved]').length ==0 ||
                $('#checkboxNewReservs:checked').val() != 'on' ||
                $('#name').val().length == 0 ||$('#phone').val().length == 0) {
                $('#errorModalLink').click();
                return;
            }

            $('#newTablesInfoModal').empty();
            $('#nameModal').val($('#name').val());
            $('#phoneModal').val($('#phone').val());
            $('#dateModal').val($('#datepicker').val());
            $('#timeModal').val($('#timePicker').val()); 
            for (var i = 0; i < $('td[newReserved="True"]').length; i++) {
                var elemId = $('td[newReserved="True"]')[i].id;
                var id = document.getElementById($('td[newReserved="True"]')[i].id).getAttribute('tableid');
                var seats = document.getElementById($('td[newReserved="True"]')[i].id).getAttribute('seats');
                $('#newTablesInfoModal').append("<input data-val=\"true\" elemid="+elemId+" id=\"tableId" + id + "\" name=\"tableId" + id + "\" type=\"hidden\" value=\"" + id + "\">");
                $('#newTablesInfoModal').append("<p><span class=\"glyphicon glyphicon-user\">" + seats + "</span></p>");
            }
            $('#confirmModalLink').click();

        });   
    }


    function CheckBoxChecked() {
        $('#checkboxNewReservs').click(function () {
            SetDefaultColorAndRemoveAttrNewreservedTD();
        });

    }

    function SetDefaultColorAndRemoveAttrNewreservedTD() {
        $('td[selected]').css("background-color", '#fcfcfc');
        $('td[selected]').removeAttr('selected');

        for (var i = 0; i < $('td[newreserved]').length; i++) {
            var id = $('td[newreserved]')[i].id;
            document.getElementById("P." + id).style.color = "black";
        }

        $('td[newreserved]').css("background-color", '#fcfcfc');
        $('td[newreserved]').removeAttr('newreserved');
    }
</script>

